<?xml version="1.0" encoding="utf-8"?>
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <!-- =============================================================================
       SCHEMA TOOLS CONFIGURATION
       
       Output Strategy:
         Source      - Generated files placed in project directory (committed to source control)
         Intermediate - Generated files placed in obj/IntermediateOutputPath (transient, not committed)
       
       All paths can be explicitly overridden regardless of strategy.
       ============================================================================= -->

  <PropertyGroup>
    <!-- Master enable -->
    <SchemaToolsEnabled Condition="'$(SchemaToolsEnabled)' == ''">true</SchemaToolsEnabled>

    <!-- Output strategy: Source (committed) vs Intermediate (transient) -->
    <SchemaToolsOutputStrategy Condition="'$(SchemaToolsOutputStrategy)' == ''">Source</SchemaToolsOutputStrategy>

    <!-- Feature toggles -->
    <SchemaToolsGenerateTriggers Condition="'$(SchemaToolsGenerateTriggers)' == ''">true</SchemaToolsGenerateTriggers>
    <SchemaToolsGenerateProcedures Condition="'$(SchemaToolsGenerateProcedures)' == ''">true</SchemaToolsGenerateProcedures>
    <SchemaToolsGenerateViews Condition="'$(SchemaToolsGenerateViews)' == ''">true</SchemaToolsGenerateViews>
    <SchemaToolsValidate Condition="'$(SchemaToolsValidate)' == ''">true</SchemaToolsValidate>
    <SchemaToolsGenerateDocs Condition="'$(SchemaToolsGenerateDocs)' == ''">true</SchemaToolsGenerateDocs>
    <SchemaToolsExtractPostBuildMetadata Condition="'$(SchemaToolsExtractPostBuildMetadata)' == ''">true</SchemaToolsExtractPostBuildMetadata>

    <!-- Configuration file (schema semantics only) -->
    <SchemaToolsConfig Condition="'$(SchemaToolsConfig)' == ''">$(MSBuildProjectDirectory)\schema-tools.json</SchemaToolsConfig>

    <!-- Select the correct TFM based on the MSBuild runtime environment -->
    <SchemaTools_TFM Condition="'$(MSBuildRuntimeType)' != 'Core'">netstandard2.0</SchemaTools_TFM>
    <SchemaTools_TFM Condition="'$(MSBuildRuntimeType)' == 'Core'">net10.0</SchemaTools_TFM>
  </PropertyGroup>

  <!-- =============================================================================
       OUTPUT PATH DEFAULTS (by strategy)
       ============================================================================= -->

  <!-- Strategy: Source - paths in project directory (committed to source control) -->
  <PropertyGroup Condition="'$(SchemaToolsOutputStrategy)' == 'Source'">
    <SchemaToolsGeneratedOutput Condition="'$(SchemaToolsGeneratedOutput)' == ''">$(MSBuildProjectDirectory)\Schema\_generated</SchemaToolsGeneratedOutput>
    <SchemaToolsTriggersOutput Condition="'$(SchemaToolsTriggersOutput)' == ''">$(SchemaToolsGeneratedOutput)</SchemaToolsTriggersOutput>
    <SchemaToolsProceduresOutput Condition="'$(SchemaToolsProceduresOutput)' == ''">$(SchemaToolsGeneratedOutput)</SchemaToolsProceduresOutput>
    <SchemaToolsViewsOutput Condition="'$(SchemaToolsViewsOutput)' == ''">$(SchemaToolsGeneratedOutput)</SchemaToolsViewsOutput>
    <SchemaToolsMetadataOutput Condition="'$(SchemaToolsMetadataOutput)' == ''">$(MSBuildProjectDirectory)\Build\schema.json</SchemaToolsMetadataOutput>
    <SchemaToolsDocsOutput Condition="'$(SchemaToolsDocsOutput)' == ''">$(MSBuildProjectDirectory)\Docs\SCHEMA.md</SchemaToolsDocsOutput>
  </PropertyGroup>

  <!-- Strategy: Intermediate - paths in obj/bin directories (transient, not committed) -->
  <PropertyGroup Condition="'$(SchemaToolsOutputStrategy)' == 'Intermediate'">
    <SchemaToolsGeneratedOutput Condition="'$(SchemaToolsGeneratedOutput)' == ''">$(IntermediateOutputPath)SchemaTools</SchemaToolsGeneratedOutput>
    <SchemaToolsTriggersOutput Condition="'$(SchemaToolsTriggersOutput)' == ''">$(SchemaToolsGeneratedOutput)</SchemaToolsTriggersOutput>
    <SchemaToolsProceduresOutput Condition="'$(SchemaToolsProceduresOutput)' == ''">$(SchemaToolsGeneratedOutput)</SchemaToolsProceduresOutput>
    <SchemaToolsViewsOutput Condition="'$(SchemaToolsViewsOutput)' == ''">$(SchemaToolsGeneratedOutput)</SchemaToolsViewsOutput>
    <SchemaToolsMetadataOutput Condition="'$(SchemaToolsMetadataOutput)' == ''">$(IntermediateOutputPath)schema.json</SchemaToolsMetadataOutput>
    <SchemaToolsDocsOutput Condition="'$(SchemaToolsDocsOutput)' == ''">$(OutputPath)SCHEMA.md</SchemaToolsDocsOutput>
  </PropertyGroup>

  <!-- Analysis output always goes to intermediate (never committed) -->
  <PropertyGroup>
    <SchemaToolsAnalysisOutput Condition="'$(SchemaToolsAnalysisOutput)' == ''">$(IntermediateOutputPath)analysis.json</SchemaToolsAnalysisOutput>
  </PropertyGroup>

  <!-- =============================================================================
       TASK DEFINITIONS

       Task assemblies live in tasks/{tfm}/ inside the NuGet package.
       Dependencies are bundled alongside the task DLL.
       
       SchemaToolsTaskAssembly can be set by the importing project to override
       the default NuGet-package-relative path (e.g., for source-tree references).
       ============================================================================= -->

  <PropertyGroup>
    <SchemaToolsTaskAssembly Condition="'$(SchemaToolsTaskAssembly)' == ''">$(MSBuildThisFileDirectory)..\tasks\$(SchemaTools_TFM)\SchemaTools.dll</SchemaToolsTaskAssembly>
  </PropertyGroup>

  <UsingTask TaskName="SchemaTools.Tasks.SchemaSourceAnalyser"
             AssemblyFile="$(SchemaToolsTaskAssembly)" />

  <UsingTask TaskName="SchemaTools.Tasks.SqlTriggerGenerator"
             AssemblyFile="$(SchemaToolsTaskAssembly)" />

  <UsingTask TaskName="SchemaTools.Tasks.SqlProcedureGenerator"
             AssemblyFile="$(SchemaToolsTaskAssembly)" />

  <!-- SchemaMetadataExtractor depends on DacFx. In Full Framework MSBuild (msbuild.exe),
       SSDT's SqlBuild target may have already loaded an older DacFx version with the same
       assembly identity (Version=170.0.0.0) into the AppDomain. Since the CLR considers
       them identical, our bundled version cannot load, causing "Could not load schema model"
       errors. TaskHostFactory runs the task in a separate process, avoiding the conflict.
       .NET Core MSBuild uses AssemblyLoadContext isolation, so no conflict arises. -->
  <UsingTask TaskName="SchemaTools.Tasks.SchemaMetadataExtractor"
             AssemblyFile="$(SchemaToolsTaskAssembly)"
             TaskFactory="TaskHostFactory"
             Condition="'$(MSBuildRuntimeType)' != 'Core'">
    <Task Runtime="CLR4" Architecture="CurrentArchitecture" />
  </UsingTask>

  <UsingTask TaskName="SchemaTools.Tasks.SchemaMetadataExtractor"
             AssemblyFile="$(SchemaToolsTaskAssembly)"
             Condition="'$(MSBuildRuntimeType)' == 'Core'" />

  <UsingTask TaskName="SchemaTools.Tasks.SchemaValidator"
             AssemblyFile="$(SchemaToolsTaskAssembly)" />

  <UsingTask TaskName="SchemaTools.Tasks.MarkdownDocumentationGenerator"
             AssemblyFile="$(SchemaToolsTaskAssembly)" />

  <UsingTask TaskName="SchemaTools.Tasks.SqlViewGenerator"
             AssemblyFile="$(SchemaToolsTaskAssembly)" />

  <!-- =============================================================================
       PRE-BUILD TARGETS
       These run before SqlBuild to generate triggers and procedures that will be
       included in the .dacpac
       ============================================================================= -->

  <!-- Phase 1: Analyse source files to build FK graph and detect patterns -->
  <Target Name="SchemaToolsAnalyse"
          BeforeTargets="BeforeBuild"
          Condition="'$(SchemaToolsEnabled)' == 'true' AND ('$(SchemaToolsGenerateTriggers)' == 'true' OR '$(SchemaToolsGenerateProcedures)' == 'true' OR '$(SchemaToolsGenerateViews)' == 'true')">
    <Message Text="SchemaTools: Analysing source files..." Importance="high" />
    <SchemaTools.Tasks.SchemaSourceAnalyser
      SqlFiles="@(Build)"
      AnalysisOutput="$(SchemaToolsAnalysisOutput)"
      GeneratedTriggersDirectory="$(SchemaToolsTriggersOutput)"
      GeneratedViewsDirectory="$(SchemaToolsViewsOutput)"
      ConfigFile="$(SchemaToolsConfig)" />
  </Target>

  <!-- Phase 2: Generate cascade soft-delete triggers for parent tables -->
  <!-- Explicit definitions anywhere in @(Build) take precedence (explicit-wins policy) -->
  <Target Name="SchemaToolsGenerateTriggers"
          AfterTargets="SchemaToolsAnalyse"
          BeforeTargets="BeforeBuild"
          Condition="'$(SchemaToolsEnabled)' == 'true' AND '$(SchemaToolsGenerateTriggers)' == 'true'">
    <Message Text="SchemaTools: Generating cascade soft-delete triggers..." Importance="high" />
    <SchemaTools.Tasks.SqlTriggerGenerator
      AnalysisFile="$(SchemaToolsAnalysisOutput)"
      OutputDirectory="$(SchemaToolsTriggersOutput)"
      Force="false" />
  </Target>

  <!-- Phase 3: Generate purge stored procedure -->
  <Target Name="SchemaToolsGenerateProcedures"
          AfterTargets="SchemaToolsGenerateTriggers"
          BeforeTargets="BeforeBuild"
          Condition="'$(SchemaToolsEnabled)' == 'true' AND '$(SchemaToolsGenerateProcedures)' == 'true'">
    <Message Text="SchemaTools: Generating purge procedures..." Importance="high" />
    <SchemaTools.Tasks.SqlProcedureGenerator
      AnalysisFile="$(SchemaToolsAnalysisOutput)"
      OutputDirectory="$(SchemaToolsProceduresOutput)"
      Force="false" />
  </Target>

  <!-- Phase 3.5: Generate active-record views for soft-delete tables -->
  <Target Name="SchemaToolsGenerateViews"
          AfterTargets="SchemaToolsGenerateProcedures"
          BeforeTargets="BeforeBuild"
          Condition="'$(SchemaToolsEnabled)' == 'true' AND '$(SchemaToolsGenerateViews)' == 'true'">
    <Message Text="SchemaTools: Generating active-record views..." Importance="high" />
    <SchemaTools.Tasks.SqlViewGenerator
      AnalysisFile="$(SchemaToolsAnalysisOutput)"
      OutputDirectory="$(SchemaToolsViewsOutput)"
      Force="false" />
  </Target>

  <!-- Phase 4: Include generated files in the build
       Remove-then-Include avoids duplicates when:
       (a) the SDK auto-includes .sql files from the project tree (Source strategy), or
       (b) multiple output properties resolve to the same directory (default). -->
  <Target Name="SchemaToolsIncludeGenerated"
          AfterTargets="SchemaToolsGenerateViews"
          BeforeTargets="BeforeBuild"
          Condition="'$(SchemaToolsEnabled)' == 'true'">
    <ItemGroup>
      <Build Remove="$(SchemaToolsTriggersOutput)\**\*.sql" />
      <Build Include="$(SchemaToolsTriggersOutput)\**\*.sql"
             Condition="Exists('$(SchemaToolsTriggersOutput)')" />
      <Build Remove="$(SchemaToolsProceduresOutput)\**\*.sql" />
      <Build Include="$(SchemaToolsProceduresOutput)\**\*.sql"
             Condition="Exists('$(SchemaToolsProceduresOutput)')" />
      <Build Remove="$(SchemaToolsViewsOutput)\**\*.sql" />
      <Build Include="$(SchemaToolsViewsOutput)\**\*.sql"
             Condition="Exists('$(SchemaToolsViewsOutput)')" />
    </ItemGroup>
  </Target>

  <!-- =============================================================================
       POST-BUILD TARGETS
       These run after SqlBuild to validate and document the compiled .dacpac
       ============================================================================= -->

  <!-- Phase 5: Extract authoritative metadata from compiled .dacpac -->
  <Target Name="SchemaToolsExtractMetadata"
          AfterTargets="Build"
          Condition="'$(SchemaToolsEnabled)' == 'true' AND '$(SchemaToolsExtractPostBuildMetadata)' == 'true'">
    <Message Text="SchemaTools: Extracting metadata from dacpac..." Importance="high" />
    <SchemaTools.Tasks.SchemaMetadataExtractor
      DacpacPath="$(TargetPath)"
      OutputFile="$(SchemaToolsMetadataOutput)"
      ConfigFile="$(SchemaToolsConfig)" />
  </Target>

  <!-- Phase 6: Validate compiled schema -->
  <Target Name="SchemaToolsValidate"
          AfterTargets="SchemaToolsExtractMetadata"
          Condition="'$(SchemaToolsEnabled)' == 'true' AND '$(SchemaToolsValidate)' == 'true'">
    <Message Text="SchemaTools: Validating schema..." Importance="high" />
    <SchemaTools.Tasks.SchemaValidator
      MetadataFile="$(SchemaToolsMetadataOutput)"
      ConfigFile="$(SchemaToolsConfig)" />
  </Target>

  <!-- Phase 7: Generate documentation from final schema -->
  <Target Name="SchemaToolsGenerateDocs"
          AfterTargets="SchemaToolsValidate"
          Condition="'$(SchemaToolsEnabled)' == 'true' AND '$(SchemaToolsGenerateDocs)' == 'true'">
    <Message Text="SchemaTools: Generating documentation..." Importance="high" />
    <SchemaTools.Tasks.MarkdownDocumentationGenerator
      MetadataFile="$(SchemaToolsMetadataOutput)"
      OutputFile="$(SchemaToolsDocsOutput)"
      ConfigFile="$(SchemaToolsConfig)" />
  </Target>

</Project>
