<?xml version="1.0" encoding="utf-8"?>
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <!-- =============================================================================
       SCHEMA TOOLS CONFIGURATION
       
       Output Strategy:
         Source      - Generated files placed in project directory (committed to source control)
         Intermediate - Generated files placed in obj/IntermediateOutputPath (transient, not committed)
       
       All paths can be explicitly overridden regardless of strategy.
       ============================================================================= -->

  <PropertyGroup>
    <!-- Master enable -->
    <SchemaToolsEnabled Condition="'$(SchemaToolsEnabled)' == ''">true</SchemaToolsEnabled>

    <!-- Output strategy: Source (committed) vs Intermediate (transient) -->
    <SchemaToolsOutputStrategy Condition="'$(SchemaToolsOutputStrategy)' == ''">Source</SchemaToolsOutputStrategy>

    <!-- Feature toggles -->
    <SchemaToolsGenerateTriggers Condition="'$(SchemaToolsGenerateTriggers)' == ''">true</SchemaToolsGenerateTriggers>
    <SchemaToolsGenerateProcedures Condition="'$(SchemaToolsGenerateProcedures)' == ''">true</SchemaToolsGenerateProcedures>
    <SchemaToolsGenerateViews Condition="'$(SchemaToolsGenerateViews)' == ''">true</SchemaToolsGenerateViews>
    <SchemaToolsValidate Condition="'$(SchemaToolsValidate)' == ''">true</SchemaToolsValidate>
    <SchemaToolsGenerateDocs Condition="'$(SchemaToolsGenerateDocs)' == ''">true</SchemaToolsGenerateDocs>
    <SchemaToolsExtractPostBuildMetadata Condition="'$(SchemaToolsExtractPostBuildMetadata)' == ''">true</SchemaToolsExtractPostBuildMetadata>

    <!-- Configuration file (schema semantics only) -->
    <SchemaToolsConfig Condition="'$(SchemaToolsConfig)' == ''">$(MSBuildProjectDirectory)\schema-tools.json</SchemaToolsConfig>

    <!-- Select the correct TFM based on the MSBuild runtime environment -->
    <SchemaTools_TFM Condition="'$(MSBuildRuntimeType)' != 'Core'">netstandard2.0</SchemaTools_TFM>
    <SchemaTools_TFM Condition="'$(MSBuildRuntimeType)' == 'Core'">net10.0</SchemaTools_TFM>
  </PropertyGroup>

  <!-- =============================================================================
       OUTPUT PATH DEFAULTS (by strategy)
       ============================================================================= -->

  <!-- Strategy: Source - paths in project directory (committed to source control) -->
  <PropertyGroup Condition="'$(SchemaToolsOutputStrategy)' == 'Source'">
    <SchemaToolsGeneratedOutput Condition="'$(SchemaToolsGeneratedOutput)' == ''">$(MSBuildProjectDirectory)\Schema\_generated</SchemaToolsGeneratedOutput>
    <SchemaToolsTriggersOutput Condition="'$(SchemaToolsTriggersOutput)' == ''">$(SchemaToolsGeneratedOutput)</SchemaToolsTriggersOutput>
    <SchemaToolsProceduresOutput Condition="'$(SchemaToolsProceduresOutput)' == ''">$(SchemaToolsGeneratedOutput)</SchemaToolsProceduresOutput>
    <SchemaToolsViewsOutput Condition="'$(SchemaToolsViewsOutput)' == ''">$(SchemaToolsGeneratedOutput)</SchemaToolsViewsOutput>
    <SchemaToolsMetadataOutput Condition="'$(SchemaToolsMetadataOutput)' == ''">$(MSBuildProjectDirectory)\schema.json</SchemaToolsMetadataOutput>
    <SchemaToolsDocsOutput Condition="'$(SchemaToolsDocsOutput)' == ''">$(MSBuildProjectDirectory)\SCHEMA.md</SchemaToolsDocsOutput>
  </PropertyGroup>

  <!-- Strategy: Intermediate - paths in obj/bin directories (transient, not committed) -->
  <PropertyGroup Condition="'$(SchemaToolsOutputStrategy)' == 'Intermediate'">
    <SchemaToolsGeneratedOutput Condition="'$(SchemaToolsGeneratedOutput)' == ''">$(IntermediateOutputPath)SchemaTools</SchemaToolsGeneratedOutput>
    <SchemaToolsTriggersOutput Condition="'$(SchemaToolsTriggersOutput)' == ''">$(SchemaToolsGeneratedOutput)</SchemaToolsTriggersOutput>
    <SchemaToolsProceduresOutput Condition="'$(SchemaToolsProceduresOutput)' == ''">$(SchemaToolsGeneratedOutput)</SchemaToolsProceduresOutput>
    <SchemaToolsViewsOutput Condition="'$(SchemaToolsViewsOutput)' == ''">$(SchemaToolsGeneratedOutput)</SchemaToolsViewsOutput>
    <SchemaToolsMetadataOutput Condition="'$(SchemaToolsMetadataOutput)' == ''">$(IntermediateOutputPath)schema.json</SchemaToolsMetadataOutput>
    <SchemaToolsDocsOutput Condition="'$(SchemaToolsDocsOutput)' == ''">$(OutputPath)SCHEMA.md</SchemaToolsDocsOutput>
  </PropertyGroup>

  <!-- Analysis output always goes to intermediate (never committed) -->
  <PropertyGroup>
    <SchemaToolsAnalysisOutput Condition="'$(SchemaToolsAnalysisOutput)' == ''">$(IntermediateOutputPath)analysis.json</SchemaToolsAnalysisOutput>
  </PropertyGroup>

  <!-- Dacpac path: both SSDT (SqlTasks.targets) and Microsoft.Build.Sql SDK define
       $(SqlTargetPath) as the canonical path to the compiled .dacpac file.
       $(TargetPath) is NOT usable here because SSDT resolves it to the output DLL.
       Evaluated inside the target because $(SqlTargetPath) is set by SDK targets,
       not available at import time. Consumers may override SchemaToolsDacpacPath
       in a static PropertyGroup if their project sets SqlTargetPath early. -->

  <!-- =============================================================================
       TASK DEFINITIONS

       Task assemblies live in tasks/{tfm}/ inside the NuGet package.
       Dependencies are bundled alongside the task DLL.
       
       SchemaToolsTaskAssembly can be set by the importing project to override
       the default NuGet-package-relative path (e.g., for source-tree references).
       ============================================================================= -->

  <PropertyGroup>
    <SchemaToolsTaskAssembly Condition="'$(SchemaToolsTaskAssembly)' == ''">$(MSBuildThisFileDirectory)..\tasks\$(SchemaTools_TFM)\SchemaTools.dll</SchemaToolsTaskAssembly>

    <!-- net10.0 assembly path: used by Full Framework MSBuild for dotnet exec invocation.
         SchemaToolsNet10Assembly can be overridden for source-tree references. -->
    <SchemaToolsNet10Assembly Condition="'$(SchemaToolsNet10Assembly)' == ''">$(MSBuildThisFileDirectory)..\tasks\net10.0\SchemaTools.dll</SchemaToolsNet10Assembly>

    <!-- Resolve the dotnet host for CLI invocation -->
    <_SchemaToolsDotnet Condition="'$(_SchemaToolsDotnet)' == '' AND '$(DOTNET_HOST_PATH)' != ''">$(DOTNET_HOST_PATH)</_SchemaToolsDotnet>
    <_SchemaToolsDotnet Condition="'$(_SchemaToolsDotnet)' == ''">dotnet</_SchemaToolsDotnet>
  </PropertyGroup>

  <UsingTask TaskName="SchemaTools.Tasks.SchemaSourceAnalyser"
             AssemblyFile="$(SchemaToolsTaskAssembly)" />

  <UsingTask TaskName="SchemaTools.Tasks.SqlTriggerGenerator"
             AssemblyFile="$(SchemaToolsTaskAssembly)" />

  <UsingTask TaskName="SchemaTools.Tasks.SqlProcedureGenerator"
             AssemblyFile="$(SchemaToolsTaskAssembly)" />

  <!-- SchemaMetadataExtractor is net10.0 only (DacFx-dependent).
       In .NET Core MSBuild it runs in-process; in Full Framework MSBuild
       it is invoked via dotnet exec (see SchemaToolsExtractMetadata target). -->
  <UsingTask TaskName="SchemaTools.Tasks.SchemaMetadataExtractor"
             AssemblyFile="$(SchemaToolsTaskAssembly)"
             Condition="'$(MSBuildRuntimeType)' == 'Core'" />

  <UsingTask TaskName="SchemaTools.Tasks.SchemaValidator"
             AssemblyFile="$(SchemaToolsTaskAssembly)" />

  <UsingTask TaskName="SchemaTools.Tasks.MarkdownDocumentationGenerator"
             AssemblyFile="$(SchemaToolsTaskAssembly)" />

  <UsingTask TaskName="SchemaTools.Tasks.SqlViewGenerator"
             AssemblyFile="$(SchemaToolsTaskAssembly)" />

  <!-- =============================================================================
       PRE-BUILD TARGETS
       These run before SqlBuild to generate triggers and procedures that will be
       included in the .dacpac
       ============================================================================= -->

  <!-- Phase 1: Analyse source files to build FK graph and detect patterns -->
  <Target Name="SchemaToolsAnalyse"
          BeforeTargets="BeforeBuild"
          Condition="'$(SchemaToolsEnabled)' == 'true' AND ('$(SchemaToolsGenerateTriggers)' == 'true' OR '$(SchemaToolsGenerateProcedures)' == 'true' OR '$(SchemaToolsGenerateViews)' == 'true')">
    <Message Text="SchemaTools: Analysing source files..." Importance="high" />
    <SchemaTools.Tasks.SchemaSourceAnalyser
      SqlFiles="@(Build)"
      AnalysisOutput="$(SchemaToolsAnalysisOutput)"
      GeneratedTriggersDirectory="$(SchemaToolsTriggersOutput)"
      GeneratedViewsDirectory="$(SchemaToolsViewsOutput)"
      ConfigFile="$(SchemaToolsConfig)" />
  </Target>

  <!-- Phase 2: Generate cascade soft-delete triggers for parent tables -->
  <!-- Explicit definitions anywhere in @(Build) take precedence (explicit-wins policy) -->
  <Target Name="SchemaToolsGenerateTriggers"
          AfterTargets="SchemaToolsAnalyse"
          BeforeTargets="BeforeBuild"
          Condition="'$(SchemaToolsEnabled)' == 'true' AND '$(SchemaToolsGenerateTriggers)' == 'true'">
    <Message Text="SchemaTools: Generating cascade soft-delete triggers..." Importance="high" />
    <SchemaTools.Tasks.SqlTriggerGenerator
      AnalysisFile="$(SchemaToolsAnalysisOutput)"
      OutputDirectory="$(SchemaToolsTriggersOutput)"
      Force="false" />
  </Target>

  <!-- Phase 3: Generate purge stored procedure -->
  <Target Name="SchemaToolsGenerateProcedures"
          AfterTargets="SchemaToolsGenerateTriggers"
          BeforeTargets="BeforeBuild"
          Condition="'$(SchemaToolsEnabled)' == 'true' AND '$(SchemaToolsGenerateProcedures)' == 'true'">
    <Message Text="SchemaTools: Generating purge procedures..." Importance="high" />
    <SchemaTools.Tasks.SqlProcedureGenerator
      AnalysisFile="$(SchemaToolsAnalysisOutput)"
      OutputDirectory="$(SchemaToolsProceduresOutput)"
      Force="false" />
  </Target>

  <!-- Phase 3.5: Generate active-record views for soft-delete tables -->
  <Target Name="SchemaToolsGenerateViews"
          AfterTargets="SchemaToolsGenerateProcedures"
          BeforeTargets="BeforeBuild"
          Condition="'$(SchemaToolsEnabled)' == 'true' AND '$(SchemaToolsGenerateViews)' == 'true'">
    <Message Text="SchemaTools: Generating active-record views..." Importance="high" />
    <SchemaTools.Tasks.SqlViewGenerator
      AnalysisFile="$(SchemaToolsAnalysisOutput)"
      OutputDirectory="$(SchemaToolsViewsOutput)"
      Force="false" />
  </Target>

  <!-- Phase 4: Include generated files in the build
       Remove-then-Include avoids duplicates when:
       (a) the SDK auto-includes .sql files from the project tree (Source strategy), or
       (b) multiple output properties resolve to the same directory (default). -->
  <Target Name="SchemaToolsIncludeGenerated"
          AfterTargets="SchemaToolsGenerateViews"
          BeforeTargets="BeforeBuild"
          Condition="'$(SchemaToolsEnabled)' == 'true'">
    <ItemGroup>
      <Build Remove="$(SchemaToolsTriggersOutput)\**\*.sql" />
      <Build Include="$(SchemaToolsTriggersOutput)\**\*.sql"
             Condition="Exists('$(SchemaToolsTriggersOutput)')" />
      <Build Remove="$(SchemaToolsProceduresOutput)\**\*.sql" />
      <Build Include="$(SchemaToolsProceduresOutput)\**\*.sql"
             Condition="Exists('$(SchemaToolsProceduresOutput)')" />
      <Build Remove="$(SchemaToolsViewsOutput)\**\*.sql" />
      <Build Include="$(SchemaToolsViewsOutput)\**\*.sql"
             Condition="Exists('$(SchemaToolsViewsOutput)')" />
    </ItemGroup>
  </Target>

  <!-- =============================================================================
       POST-BUILD TARGETS
       These run after SqlBuild to validate and document the compiled .dacpac
       ============================================================================= -->

  <!-- Phase 5: Extract authoritative metadata from compiled .dacpac.
       .NET Core MSBuild: in-process task (AssemblyLoadContext provides isolation).
       Full Framework MSBuild: dotnet exec invocation (separate process avoids
       SSDT DacFx assembly identity collision in the shared AppDomain).
       Requires .NET 10 SDK. -->
  <Target Name="SchemaToolsExtractMetadata"
          AfterTargets="Build"
          Condition="'$(SchemaToolsEnabled)' == 'true' AND '$(SchemaToolsExtractPostBuildMetadata)' == 'true'">
    <Message Text="SchemaTools: Extracting metadata from dacpac..." Importance="high" />

    <!-- Resolve the dacpac path at execution time (SqlTargetPath is set by SDK targets). -->
    <PropertyGroup>
      <SchemaToolsDacpacPath Condition="'$(SchemaToolsDacpacPath)' == ''">$(SqlTargetPath)</SchemaToolsDacpacPath>
    </PropertyGroup>

    <!-- .NET Core MSBuild: in-process -->
    <SchemaTools.Tasks.SchemaMetadataExtractor
      DacpacPath="$(SchemaToolsDacpacPath)"
      OutputFile="$(SchemaToolsMetadataOutput)"
      ConfigFile="$(SchemaToolsConfig)"
      AnalysisFile="$(SchemaToolsAnalysisOutput)"
      Condition="'$(MSBuildRuntimeType)' == 'Core'" />

    <!-- Full Framework MSBuild: dotnet exec -->
    <Exec Command="&quot;$(_SchemaToolsDotnet)&quot; exec &quot;$(SchemaToolsNet10Assembly)&quot; extract-metadata --dacpac &quot;$(SchemaToolsDacpacPath)&quot; --output &quot;$(SchemaToolsMetadataOutput)&quot; --config &quot;$(SchemaToolsConfig)&quot; --analysis &quot;$(SchemaToolsAnalysisOutput)&quot;"
          Condition="'$(MSBuildRuntimeType)' != 'Core'" />
  </Target>

  <!-- Phase 6: Validate compiled schema -->
  <Target Name="SchemaToolsValidate"
          AfterTargets="SchemaToolsExtractMetadata"
          Condition="'$(SchemaToolsEnabled)' == 'true' AND '$(SchemaToolsValidate)' == 'true'">
    <Message Text="SchemaTools: Validating schema..." Importance="high" />
    <SchemaTools.Tasks.SchemaValidator
      MetadataFile="$(SchemaToolsMetadataOutput)"
      ConfigFile="$(SchemaToolsConfig)" />
  </Target>

  <!-- Phase 7: Generate documentation from final schema -->
  <Target Name="SchemaToolsGenerateDocs"
          AfterTargets="SchemaToolsValidate"
          Condition="'$(SchemaToolsEnabled)' == 'true' AND '$(SchemaToolsGenerateDocs)' == 'true'">
    <Message Text="SchemaTools: Generating documentation..." Importance="high" />
    <SchemaTools.Tasks.MarkdownDocumentationGenerator
      MetadataFile="$(SchemaToolsMetadataOutput)"
      OutputFile="$(SchemaToolsDocsOutput)"
      ConfigFile="$(SchemaToolsConfig)" />
  </Target>

</Project>
